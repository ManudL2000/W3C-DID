zenchain: 1.0
start: v1/sandbox/pubkeys-accept-1-path.zen
blocks:
  v1/sandbox/pubkeys-accept-1-path.zen:
    zenContent: |
      rule input encoding base58
      Scenario 'ecdh': singature
      Scenario 'w3c': did document
      
      Given I have a 'did document' named 'did document'
      and I rename 'did_document' to 'request_did_document'
      and I have a 'ecdh signature'
      and I have a 'string' named 'id'
      and I rename 'id' to 'signer_id'

      # constants
      Given I have a 'string dictionary' named 'request_ACL'
      and I have a 'string dictionary' named 'signer_ACL'
      and I have a 'string dictionary' named 'utility'

      When I set ':' to ':' as 'string'
      and I set '.' to '.' as 'string'
      and I set 'signer_path' to 'data/' as 'string'
      and I set 'request_path' to 'data/' as 'string'

      # signer_parts
      When I create the array by splitting 'signer_id' at ':'
      and I create the copy of element '3' in array 'array'
      and I rename the 'copy' to 'signer_idspec'
      and I create the copy of element '4' in array 'array'
      and I rename the 'copy' to 'signer_idpk'
      and I remove 'array'

      # request_parts
      When I pickup from path 'request_did_document.id'
      and I rename the 'id' to 'request_id'
      and I create the array by splitting 'request_id' at ':'
      and I create the copy of element '3' in array 'array'
      and I rename the 'copy' to 'request_idspec'
      and I create the copy of element '4' in array 'array'
      and I rename the 'copy' to 'request_idpk'
      and I remove 'array'

      # signer_path
      When I create the array by splitting 'signer_idspec' at '.'
      and I create the length of 'array'
      # no point => has to be admin
      If I verify 'length' is equal to '1' in 'utility'
      When I verify 'signer_idspec' is equal to 'admin' in 'utility'
      EndIf
      # if point => then .A or .C
      If I verify 'length' is not equal to '1' in 'utility'
      When I verify 'length' is equal to '2' in 'utility'
      and I create the copy of element '1' in array 'array'
      and I remove 'signer_idspec'
      and I rename 'copy' to 'signer_idspec'
      and I verify 'signer_idspec' is equal to 'request_idspec'
      and I create the copy of element '2' in array 'array'
      and the 'copy' is found in 'signer_ACL'
      and I append the string '/' to 'signer_idspec'
      and I append 'copy' to 'signer_idspec'
      and I remove 'array'
      and I remove 'copy'
      and I remove 'length'
      EndIf
      When I append 'signer_idspec' to 'signer_path'
      and I append the string '/' to 'signer_path'
      and I append 'signer_idpk' to 'signer_path'

      # request_path
      When I create the array by splitting 'request_idspec' at '.'
      and I create the length of 'array'
      If I verify 'length' is not equal to '1' in 'utility'
      When I verify 'length' is equal to '2' in 'utility'
      and I create the copy of element '1' in array 'array'
      and I remove 'request_idspec'
      and I rename 'copy' to 'request_idspec'
      and I create the copy of element '2' in array 'array'
      and the 'copy' is found in 'request_ACL'
      and I append the string '/' to 'request_idspec'
      and I append 'copy' to 'request_idspec'
      and I remove 'array'
      and I remove 'copy'
      and I remove 'length'
      EndIf
      When I append 'request_idspec' to 'request_path'
      and I append the string '/' to 'request_path'
      and I append 'request_idpk' to 'request_path'

      Then print the 'signer_path'
      Then print the 'request_path'
      Then print the 'request_did_document'
      Then print the 'signer_id'
      Then print the 'ecdh_signature'
    keysFile: v1/sandbox/pubkeys-accept-1-path.keys
    next: v1/sandbox/pubkeys-accept-2-checks.zen
  v1/sandbox/pubkeys-accept-2-checks.zen:
    zenContent: |
      Rule caller restroom-mw
      Scenario 'ecdh': verify signature
      Scenario 'w3c': proof
      
      ## proof needs:
      # - timestamp
      Given I fetch the local timestamp and store it into 'timestamp'
      and I have a 'string' named 'timestamp'

      # signer did document
      Given I read the content of 'signer_path'
      Given I have a 'did document' named 'didDocument'
      Given I rename 'didDocument' to 'signer_did_document'

      # key
      Given I have a 'string dictionary' named 'proof'
      and I have a 'string' named '@context'
      # data
      Given I have a 'did document' named 'request did document'
      and I have a 'ecdh signature'
      and I have a 'string' named 'request_path'
      and I have a 'string' named 'signer_id'

      # verify singautres
      When I create the verificationMethod of 'signer_did_document'
      and I pickup a 'ecdh_public_key' from path 'verificationMethod.ecdh_public_key'
      and I create the json of 'request did document'
      and I verify the 'json' has a ecdh signature in 'ecdh signature' by 'ecdh public key'
      and I remove the 'verificationMethod'

      # create proof
      When I create the jws signature using the ecdh signature in 'ecdh signature'
      and I move 'jws' in 'proof'
      and I copy the 'timestamp' to 'created' in 'proof'

      # proof's verification method
      When I append the string '#ecdh_public_key' to 'signer_id'
      and I move the 'signer_id' to 'verificationMethod' in 'proof'
      and I move 'proof' in 'request did document'
      
      # metadata
      When I create the 'string dictionary' named 'didDocumentMetadata'
      and I move the 'timestamp' to 'created' in 'didDocumentMetadata'
      
      # result
      When I create the 'string dictionary' named 'result'
      and I move '@context' in 'result'
      and I move the 'request_did_document' to 'didDocument' in 'result'
      and I move 'didDocumentMetadata' in 'result'
      
      Then print the 'result'
      and print the 'request_path'
      
      Then store 'result' in the file 'request_path'
    keysFile: v1/sandbox/pubkeys-accept-2-checks.keys
