---
- name: create non root user
  hosts: all
  remote_user: root
  tasks:
  - name: Add the user 'controller'
    ansible.builtin.user:
      name: controller
      shell: /bin/bash
  - name: Create .ssh directory
    file:
      path: /home/controller/.ssh
      state: directory
      owner: controller
      group: controller
  - name: Set authorized keys for user controller
    copy:
      src: /root/.ssh/authorized_keys
      remote_src: true
      dest: /home/controller/.ssh/authorized_keys
      owner: controller
      group: controller

- name: install controller
  hosts: all
  remote_user: root
  become_user: controller
  become_method: su
  vars:
    controller_root: "/controller"
  tasks:
  - name: Install node repository
    shell: curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
  - name: Update and upgrade apt packages
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 # One day

  - name: install package dependencies
    ansible.builtin.package:
      name:
       - nginx
       - curl
       - rsync
       - nodejs
      state: latest

  - name: create root for controller
    file:
      path: "{{ controller_root }}"
      state: directory
      owner: controller
      group: controller

#  - name: importing restroom
#    become: true
#    command: npx -y create-restroom@next --all restroom
#    args:
#      chdir: "{{ controller_root }}"

  - name: Create .env
    become: true
    blockinfile:
      path: "{{ controller_root }}/.env"
      create: true
      block: |
        CUSTOM_404_MESSAGE=nothing to see here
        HTTP_PORT=12001
        HTTPS_PORT=443
        ZENCODE_DIR={{ controller_root }}/contracts
        FILES_DIR={{ controller_root }}
        CHAIN_EXT=chain
        OPENAPI=true
        YML_EXT=yml
        HOST=did.dyne.org
        RESOLVER_HOST=localhost
        RESOLVER_PORT=12002

  - name: Link .env from outer dirctory
    become: true
    file:
      src: "{{ controller_root }}/.env"
      dest: "{{ controller_root }}/restroom/.env"
      state: link

  - name: Modify package.json in restroom
    become: true
    command: >
      sed -i 's/"name": "restroom",/"name": "W3C-DID",/;
      s/"start": "ZENCODE_DIR=contracts node restroom.mjs"/"start": "node restroom.mjs"/'
        restroom/package.json
    args:
      chdir: "{{ controller_root }}"


  - name: Copy contracts (permissions may be wrong)
    become: true
    synchronize:
      src: "../contracts"
      dest: "{{ controller_root }}"
      owner: no
      group: no

  - name: Fix contracts permissions
    file:
      dest: "{{ controller_root }}/contracts"
      owner: controller
      group: controller
      recurse: yes

  - name: create root for resolver
    become: true
    file:
      path: "{{ controller_root }}/resolver"
      state: directory
      owner: controller
      group: controller

  - name: download resolver
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/resolver/resolver.js"
      dest: "{{ controller_root }}/resolver/resolver.js"

  - name: download package.json resolver
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/resolver/package.json"
      dest: "{{ controller_root }}/resolver/package.json"

  - name: download pm2 ecosystem
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/ecosystem.config.js"
      dest: "{{ controller_root }}/ecosystem.config.js"

  - name: Update packages of resolver
    become: true
    community.general.yarn:
      path: "{{ controller_root }}/resolver"
      state: latest

  - name: Nginx service
    blockinfile:
      dest: "/etc/nginx/conf.d/controller.conf"
      create: true
      block: |
        server {
          listen 12000 default_server;
          listen [::]:12000 default_server;

          server_name _;
          include /etc/nginx/mime.types;

          location /1.0/identifiers {
            proxy_pass http://127.0.0.1:12002;
          }
          location / {
            proxy_pass http://did.dyne.org:12001;
          }
        }
