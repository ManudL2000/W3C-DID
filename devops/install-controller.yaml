---
- name: Create non root user
  hosts: all
  remote_user: root
  tasks:
  - name: Add the user 'controller'
    ansible.builtin.user:
      name: controller
      shell: /bin/bash
  - name: Create .ssh directory
    file:
      path: /home/controller/.ssh
      state: directory
      owner: controller
      group: controller
  - name: Set authorized keys for user controller
    copy:
      src: /root/.ssh/authorized_keys
      remote_src: true
      dest: /home/controller/.ssh/authorized_keys
      owner: controller
      group: controller

- name: Install controller
  hosts: all
  remote_user: root
  become_user: controller
  become_method: su
  vars:
    controller_root: "/controller"
  tasks:
  - name: Install node repository
    shell: curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
  - name: Update and upgrade apt packages
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 # One day

  - name: Install package dependencies
    ansible.builtin.package:
      name:
       - nginx
       - curl
       - rsync
       - nodejs
       - jq
      state: latest

  - name: Create root for controller
    file:
      path: "{{ controller_root }}"
      state: directory
      owner: controller
      group: controller

  - name: Check restroom
    stat:
      path: "{{ controller_root }}/restroom"
    register: restroom_found

  - name: Importing restroom
    become: true
    command: npx -y create-restroom@next --all restroom
    args:
      chdir: "{{ controller_root }}"
    when: not restroom_found.stat.exists

  - name: Download init.mjs
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/init.mjs"
      dest: "{{ controller_root }}/restroom/init.mjs"

  - name: Create .env
    become: true
    blockinfile:
      path: "{{ controller_root }}/.env"
      create: true
      block: |
        CUSTOM_404_MESSAGE=nothing to see here
        HTTP_PORT=12001
        HTTPS_PORT=443
        ZENCODE_DIR={{ controller_root }}/contracts
        PRIVATE_ZENCODE_DIR={{ controller_root }}/private_contracts
        FILES_DIR={{ controller_root }}
        CHAIN_EXT=chain
        OPENAPI=true
        YML_EXT=yml
        HOST=did.dyne.org
        RESOLVER_HOST=localhost
        RESOLVER_PORT=12002

  - name: Link .env from outer dirctory
    become: true
    file:
      src: "{{ controller_root }}/.env"
      dest: "{{ controller_root }}/restroom/.env"
      state: link

  - name: Create temporary file
    become: true
    tempfile:
      state: file
      suffix: temp
    register: tempfile_1

  - debug:
      msg: "{{ tempfile_1.path }}"

  - name: Modify package.json in restroom
    become: true
    shell: >
      jq '.scripts = { init: "node init.mjs", start: "node restroom.mjs" } | .name = "W3C-DID"'
      restroom/package.json > "{{ tempfile_1.path }}" &&
      mv "{{ tempfile_1.path }}" restroom/package.json
    args:
      chdir: "{{ controller_root }}"

  - name: Copy contracts (permissions may be wrong)
    become: true
    synchronize:
      src: "../contracts"
      dest: "{{ controller_root }}"
      owner: no
      group: no

  - name: Fix contracts permissions
    file:
      dest: "{{ controller_root }}/contracts"
      owner: controller
      group: controller
      recurse: yes

  - name: Copy private_contracts
    become: true
    synchronize:
      src: "../private_contracts"
      dest: "{{ controller_root }}"
      owner: no
      group: no

  - name: Fix private_contracts permissions
    file:
      dest: "{{ controller_root }}/private_contracts"
      owner: controller
      group: controller
      recurse: yes

  - name: Create root for resolver
    become: true
    file:
      path: "{{ controller_root }}/resolver"
      state: directory
      owner: controller
      group: controller

  - name: Download resolver
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/resolver/resolver.js"
      dest: "{{ controller_root }}/resolver/resolver.js"

  - name: Download package.json resolver
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/resolver/package.json"
      dest: "{{ controller_root }}/resolver/package.json"

  - name: Download pm2 ecosystem
    become: true
    get_url:
      url: "https://raw.githubusercontent.com/dyne/W3C-DID/main/ecosystem.config.js"
      dest: "{{ controller_root }}/ecosystem.config.js"

  - name: Update packages of resolver
    become: true
    community.general.yarn:
      path: "{{ controller_root }}/resolver"
      state: latest

  - name: Nginx service
    blockinfile:
      dest: "/etc/nginx/conf.d/controller.conf"
      create: true
      block: |
        server {
          listen 12000 default_server;
          listen [::]:12000 default_server;

          server_name _;
          include /etc/nginx/mime.types;

          location /1.0/identifiers {
            proxy_pass http://127.0.0.1:12002;
          }
          location / {
            proxy_pass http://did.dyne.org:12001;
          }
        }
